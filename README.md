# JTE Test App (Symfony API)

Приложение на Symfony 8.0 для управления заказами и проверки цен.

## Технологический стек
- **PHP 8.4** (FPM)
- **Symfony 8.0** (Skeleton)
- **MySQL 8.0** (База данных)
- **Manticore Search 6.2** (Полнотекстовый поиск)
- **Docker & Docker Compose** (Инфраструктура)

---

## Установка и запуск

### 1. Клонирование репозитория и настройка окружения
```bash
cp .env .env.local
```
Отредактируйте `.env.local`, если необходимо изменить порты или доступы к БД.

### 2. Запуск контейнеров
```bash
docker-compose up -d
```

### 3. Установка зависимостей и подготовка БД
```bash
docker-compose exec php composer install
docker-compose exec php bin/console doctrine:migrations:migrate --no-interaction
```

### 4. Первичная индексация Manticore Search
Для работы полнотекстового поиска необходимо проиндексировать данные:
```bash
docker-compose exec php bin/console app:index-orders
```

---

## API Эндпоинты

### Документация (OpenAPI)
Документация доступна в двух форматах:
- **Swagger UI (HTML)**: `GET /api/doc`
- **OpenAPI JSON**: `GET /api/doc.json`

Вы можете открыть [http://localhost:8080/api/doc](http://localhost:8080/api/doc) в браузере для просмотра интерактивной документации.

### 1. Получение цены (Парсинг)
**Запрос:** `GET /api/v1/price?factory=...&collection=...&article=...`

Пример:
```bash
curl "http://localhost:8080/api/v1/price?factory=A&collection=B&article=C"
```

### 2. Статистика по заказам
**Запрос:** `GET /api/v1/orders/stats?group_by=day&page=1&limit=10`

Параметры `group_by`: `day`, `month`, `year`.

### 3. Создание заказа (SOAP)
**WSDL:** `http://localhost:8080/api/v1/soap?wsdl`

Эндпоинт принимает SOAP-запросы для создания заказов.

### 4. Получение заказа по ID
**Запрос:** `GET /api/v1/orders/{id}`

### 5. Поиск заказов (Manticore)
**Запрос:** `GET /api/v1/orders/search?query=...&page=1&limit=10`

---

## Тестирование
Запуск всех тестов:
```bash
docker-compose exec php vendor/bin/phpunit
```

## Архитектура
Проект реализован с использованием принципов **Clean Architecture**:
- `src/Domain`: Сущности и интерфейсы репозиториев.
- `src/Application`: Use Cases и DTO.
- `src/Infrastructure`: Реализация интерфейсов (Doctrine, Manticore, External Parsers), контроллеры.

## Команды Manticore
- `app:index-orders` — Полная переиндексация заказов из MySQL в Manticore Search. Поддерживает zero-downtime через ротацию индексов.

---

### Анализ и улучшение структуры базы данных

В ходе анализа исходной версии базы данных были выявлены следующие недостатки и области для улучшения:

#### 1. Отсутствие внешних ключей (Foreign Keys)
В исходной версии связи между таблицами (`orders_article.orders_id -> orders.id`) не были закреплены на уровне СУБД. Это могло привести к нарушению целостности данных (появлению "сиротских" записей в `orders_article`).
**Решение:** В текущей версии добавлен `FOREIGN KEY` с правилом `ON DELETE CASCADE`.

#### 2. Типы данных для финансовых расчетов
Использование `double` для денежных сумм и весов в исходной версии могло привести к ошибкам округления.
**Решение:** Все суммы и веса переведены в `DECIMAL` (например, `decimal(12,2)`, `decimal(14,3)`), что критично для финансовых расчетов.

#### 3. Именование и структура индексов
- Имена индексов в исходной версии были неинформативны (`IDX_1`, `IDX_2`).
- Отсутствовали `UNIQUE` ограничения для полей `hash` и `token`, что могло привести к дублированию заказов.
**Решение:** Индексы переименованы в соответствии со стандартом (`idx_orders_status`, `idx_orders_user`), а для `hash` и `token` добавлены `UNIQUE KEY`. Также добавлен индекс `idx_orders_number` для быстрого поиска.

#### 4. Работа с неструктурированными данными
Поле `warehouse_data` в исходной версии имело тип `longtext`.
**Решение:** Тип изменен на `JSON`, что позволяет использовать встроенные функции MySQL для работы с JSON-структурами.

#### 5. Современные стандарты и автоматизация
- Кодировка в исходной версии была менее универсальной.
- Отсутствовали автоматические метки времени для создания и обновления записей.
**Решение:** Установлена кодировка `utf8mb4_unicode_ci` и добавлены автоматические метки: `create_date` с `DEFAULT CURRENT_TIMESTAMP` и `update_date` с `ON UPDATE CURRENT_TIMESTAMP`.

#### 6. Масштабируемость идентификаторов
В исходной версии использовался тип `INT` для первичных ключей.
**Решение:** Идентификаторы переведены в `BIGINT UNSIGNED`, что гарантирует поддержку огромных объемов данных.
